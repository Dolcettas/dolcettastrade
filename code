-- Adopt Me Fake Trade Visualizer (Client-Sided)
-- Pink Theme by Bella
-- Enhanced with Pet Spawner Pro

-----------------------------
-- Services & core modules --
-----------------------------
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")

local LocalPlayer = Players.LocalPlayer
local playerGui = LocalPlayer:WaitForChild("PlayerGui")

-- Cleanup old GUI
local oldGui = playerGui:FindFirstChild("VisualTradeGui")
if oldGui then
    oldGui:Destroy()
end

-- Wait for Fsys
local Fsys
local UIManager
local success, errorMsg = pcall(function()
    Fsys = require(ReplicatedStorage:WaitForChild("Fsys"))
    UIManager = Fsys.load("UIManager")
end)

if not success then
    warn("[PinkTrade] Failed to load UIManager:", errorMsg)
    return
end

-- Add pink-style glow effect
local function createPinkGlow(frame)
    local glow = Instance.new("Frame")
    glow.Name = "PinkGlow"
    glow.Size = UDim2.new(1, 40, 1, 40)
    glow.Position = UDim2.new(0, -20, 0, -20)
    glow.BackgroundTransparency = 1
    glow.BorderSizePixel = 0
    glow.ZIndex = -1
    glow.Parent = frame
    
    local uig = Instance.new("UIGradient")
    uig.Rotation = 90
    uig.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 100, 200)),
        ColorSequenceKeypoint.new(0.5, Color3.fromRGB(255, 150, 250)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 100, 200))
    })
    uig.Parent = glow
    
    local uistroke = Instance.new("UIStroke")
    uistroke.Color = Color3.fromRGB(255, 120, 220)
    uistroke.Thickness = 4
    uistroke.Transparency = 0.7
    uistroke.Parent = glow
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 16)
    corner.Parent = glow
    
    return glow
end

-----------------
-- Trade setup --
-----------------
local TradeApp = UIManager.apps.TradeApp
if not TradeApp then
    warn("[PinkTrade] TradeApp not found. Abort.")
    return
end

-- Keep originals
local originalAccept = TradeApp._on_accept_pressed
local originalConfirm = TradeApp._on_confirm_pressed
local originalOverwrite = TradeApp._overwrite_local_trade_state
local originalRemove = TradeApp._remove_item_from_my_offer or function() end

-- State
local fakeActive = false
local fakeTradeId = nil
local currentTargetName = ""
local currentTargetDisplayName = ""
local currentTargetId = 0
local desiredMaxSpectators = 5
local spectatorLoopRunning = false
local allowOverwrite = false
local tradeUnlockAt = 0
local LOCK_DURATION = 5

-- Static ghost users
local STATIC_PLAYER_NAMES = {
    "ROBOTVlXEN",
    "3pvsm",
    "barborich2",
    "hzm13033",
    "cammyxboba",
    "maxstropicxx",
    "cutesyxclaire",
    "1lyyellsx",
}

-- Cache for name lookups
local cachedUserIds = {}

-- Block real trade dialogs while in fake trade
local DialogApp = UIManager.apps.DialogApp
local originalDialog = DialogApp and DialogApp.dialog
local blockRealTrades = false
local allowMockDialog = false

if DialogApp and originalDialog then
    DialogApp.dialog = function(self, options, ...)
        if allowMockDialog then
            return originalDialog(self, options, ...)
        end

        if fakeActive and blockRealTrades and type(options) == "table" then
            local txt = tostring(options.text or ""):lower()
            if txt:find("sent you a trade request", 1, true)
            or txt:find("wants to trade", 1, true)
            or txt:find("trade request", 1, true) then
                print("[PinkTrade] Auto-declined real trade dialog")
                return "Decline"
            end
        end

        return originalDialog(self, options, ...)
    end
end

-----------------
-- Pet library --
-----------------
local PET_KINDS = {
    "ugc_refresh_2023_african_wild_dog",
    "albino_monkey",
    "arctic_reindeer",
    "summerfest_2024_balloon_unicorn",
    "bat_dragon",
    "lures_2023_blazing_lion",
    "easter_2024_candyfloss_chick",
    "crow",
    "frost_dragon",
    "giraffe",
    "pride_2022_goat",
    "springfest_2023_hare",
    "elf_hedgehog",
    "owl",
    "parrot",
    "winter_2023_peppermint_penguin",
    "shadow_dragon",
    "meme_2023_sheeeeep",
    "winter_2022_strawberry_shortcake_bat_dragon",
}

local RARITY_PROPS = {
    { mega_neon = true, neon = false, flyable = true, rideable = true }, -- MFR
    { mega_neon = false, neon = true, flyable = true, rideable = true }, -- NFR
    { mega_neon = false, neon = false, flyable = true, rideable = true }, -- FR
}

-- Partner chat presets
local CHAT_PRESETS = {
    "Hii!",
    "Everyone follow her!",
    "i love these petssss! <3",
    "AHHHH I LOVE YOU TRUSTEDDD",
    "can you spin this",
    "Can you boost?",
    "I followed u",
    "UR LEGIT",
    "WAIT OMG ITS REAL-",
    "could u add more?",
    "Do I get follower gift?",
    "ur so under",
    "OMG I LOVE YOUR LIVES",
    "ew swap",
    "Thanks for taking ur time",
}

-- Helper functions
local function formatPetName(kind)
    return kind:gsub("_", " "):gsub("(%a)([%w_']*)", function(a,b)
        return a:upper() .. b:lower()
    end)
end

local function tagForProps(props)
    if props and props.mega_neon then return "MFR" end
    if props and props.neon then return "NFR" end
    return "FR"
end

local function getLocalState()
    if TradeApp and TradeApp._get_local_trade_state then
        return TradeApp:_get_local_trade_state()
    end
    return nil
end

-- Name fixing system
local partnerNameLabel = nil
local partnerNameConn = nil

local function findPartnerNameLabel()
    if partnerNameLabel and partnerNameLabel.Parent then
        return partnerNameLabel
    end

    local frame = TradeApp.frame
    if not frame or not frame.Parent then
        return nil
    end

    local targetLower = tostring(currentTargetName or ""):lower()
    if targetLower == "" then return nil end

    for _, d in ipairs(frame:GetDescendants()) do
        if (d:IsA("TextLabel") or d:IsA("TextButton")) and typeof(d.Text) == "string" then
            if d.Text:lower() == targetLower then
                partnerNameLabel = d
                return partnerNameLabel
            end
        end
    end
    return nil
end

local function updatePartnerName()
    if not fakeActive then return end
    local lbl = findPartnerNameLabel()
    if not lbl then return end
    if typeof(lbl.Text) == "string"
        and lbl.Text ~= currentTargetDisplayName
        and lbl.Text:lower() == tostring(currentTargetName or ""):lower()
    then
        lbl.Text = currentTargetDisplayName
    end
end

local function startNameFix()
    if partnerNameConn then partnerNameConn:Disconnect() end
    partnerNameConn = RunService.RenderStepped:Connect(updatePartnerName)
end

local function stopNameFix()
    if partnerNameConn then
        partnerNameConn:Disconnect()
        partnerNameConn = nil
    end
    partnerNameLabel = nil
end

-- Player list functions
local function setCurrentTarget(displayName, id)
    currentTargetDisplayName = displayName
    currentTargetName = displayName
    currentTargetId = id or 0
    if selectedPartner then
        selectedPartner.Text = "Partner: " .. currentTargetDisplayName
    end
    if statusText then
        statusText.Text = "Target: " .. displayName
        statusText.TextColor3 = Color3.fromRGB(200, 255, 150)
    end
end

local function getUserIdFromName(name)
    if cachedUserIds[name] ~= nil then
        return cachedUserIds[name]
    end
    local id = 0
    local ok, result = pcall(function()
        return Players:GetUserIdFromNameAsync(name)
    end)
    if ok then
        id = result
    end
    cachedUserIds[name] = id
    return id
end

-- ScreenGui & UI (Pink Theme)
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "VisualTradeGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

-- Intro screen
local introFrame = Instance.new("Frame")
introFrame.Name = "PinkIntro"
introFrame.Size = UDim2.new(0, 280, 0, 130)
introFrame.Position = UDim2.new(0.5, -140, 0.5, -65)
introFrame.BackgroundColor3 = Color3.fromRGB(30, 10, 25)
introFrame.BackgroundTransparency = 0.1
introFrame.BorderSizePixel = 0
introFrame.Parent = screenGui

local introCorner = Instance.new("UICorner")
introCorner.CornerRadius = UDim.new(0, 20)
introCorner.Parent = introFrame

createPinkGlow(introFrame)

local heartLogo = Instance.new("TextLabel")
heartLogo.Size = UDim2.new(1, 0, 0, 40)
heartLogo.Position = UDim2.new(0, 0, 0, 15)
heartLogo.BackgroundTransparency = 1
heartLogo.Text = "‚ù§"
heartLogo.Font = Enum.Font.GothamBlack
heartLogo.TextSize = 42
heartLogo.TextColor3 = Color3.fromRGB(255, 100, 200)
heartLogo.Parent = introFrame

local introTitle = Instance.new("TextLabel")
introTitle.Size = UDim2.new(1, 0, 0, 30)
introTitle.Position = UDim2.new(0, 0, 0, 55)
introTitle.BackgroundTransparency = 1
introTitle.Text = "Visual System by Dolcetta"
introTitle.Font = Enum.Font.GothamBold
introTitle.TextSize = 16
introTitle.TextColor3 = Color3.fromRGB(255, 200, 230)
introTitle.Parent = introFrame

local introDesc = Instance.new("TextLabel")
introDesc.Size = UDim2.new(1, -40, 0, 40)
introDesc.Position = UDim2.new(0, 20, 0, 85)
introDesc.BackgroundTransparency = 1
introDesc.Text = "Beautiful visual trade simulator with pink theme"
introDesc.Font = Enum.Font.Gotham
introDesc.TextSize = 12
introDesc.TextColor3 = Color3.fromRGB(255, 180, 220)
introDesc.TextWrapped = true
introDesc.Parent = introFrame

local activateBtn = Instance.new("TextButton")
activateBtn.Size = UDim2.new(0.6, 0, 0, 35)
activateBtn.Position = UDim2.new(0.2, 0, 1, -45)
activateBtn.BackgroundColor3 = Color3.fromRGB(255, 100, 200)
activateBtn.BorderSizePixel = 0
activateBtn.Font = Enum.Font.GothamBold
activateBtn.TextSize = 14
activateBtn.TextColor3 = Color3.new(1,1,1)
activateBtn.Text = "ACTIVATE ‚ù§"
activateBtn.Parent = introFrame

local btnCorner = Instance.new("UICorner")
btnCorner.CornerRadius = UDim.new(0, 10)
btnCorner.Parent = activateBtn

-- Main panel (Draggable)
local mainContainer = Instance.new("Frame")
mainContainer.Name = "PinkContainer"
mainContainer.Size = UDim2.new(0, 220, 0, 420)
mainContainer.Position = UDim2.new(0, 15, 0, 100)
mainContainer.BackgroundColor3 = Color3.fromRGB(30, 10, 25)
mainContainer.BackgroundTransparency = 0.1
mainContainer.BorderSizePixel = 0
mainContainer.Visible = false
mainContainer.Active = true
mainContainer.Draggable = true
mainContainer.Parent = screenGui

local containerCorner = Instance.new("UICorner")
containerCorner.CornerRadius = UDim.new(0, 20)
containerCorner.Parent = mainContainer

createPinkGlow(mainContainer)

-- Header (draggable area)
local header = Instance.new("Frame")
header.Size = UDim2.new(1, 0, 0, 45)
header.BackgroundColor3 = Color3.fromRGB(40, 15, 35)
header.BorderSizePixel = 0
header.Parent = mainContainer

local headerCorner = Instance.new("UICorner")
headerCorner.CornerRadius = UDim.new(0, 20)
headerCorner.Parent = header

local pinkTitle = Instance.new("TextLabel")
pinkTitle.Size = UDim2.new(1, -40, 1, 0)
pinkTitle.Position = UDim2.new(0, 15, 0, 0)
pinkTitle.BackgroundTransparency = 1
pinkTitle.Text = "üíï DOLCETTA'S V2"
pinkTitle.Font = Enum.Font.GothamBold
pinkTitle.TextSize = 16
pinkTitle.TextColor3 = Color3.fromRGB(255, 150, 250)
pinkTitle.TextXAlignment = Enum.TextXAlignment.Left
pinkTitle.Parent = header

local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0, 30, 0, 30)
closeBtn.Position = UDim2.new(1, -35, 0.5, -15)
closeBtn.BackgroundTransparency = 1
closeBtn.Text = "√ó"
closeBtn.Font = Enum.Font.GothamBold
closeBtn.TextSize = 20
closeBtn.TextColor3 = Color3.fromRGB(255, 150, 200)
closeBtn.Parent = header

-- Status
local statusBar = Instance.new("Frame")
statusBar.Size = UDim2.new(1, -30, 0, 28)
statusBar.Position = UDim2.new(0, 15, 0, 55)
statusBar.BackgroundColor3 = Color3.fromRGB(40, 20, 35)
statusBar.BorderSizePixel = 0
statusBar.Parent = mainContainer

local statusCorner = Instance.new("UICorner")
statusCorner.CornerRadius = UDim.new(0, 10)
statusCorner.Parent = statusBar

local statusText = Instance.new("TextLabel")
statusText.Size = UDim2.new(1, -10, 1, 0)
statusText.Position = UDim2.new(0, 5, 0, 0)
statusText.BackgroundTransparency = 1
statusText.Text = "Ready"
statusText.Font = Enum.Font.GothamMedium
statusText.TextSize = 12
statusText.TextColor3 = Color3.fromRGB(255, 180, 230)
statusText.TextXAlignment = Enum.TextXAlignment.Left
statusText.Parent = statusBar

-- Tab system
local tabContainer = Instance.new("Frame")
tabContainer.Size = UDim2.new(1, -30, 0, 40)
tabContainer.Position = UDim2.new(0, 15, 0, 90)
tabContainer.BackgroundTransparency = 1
tabContainer.Parent = mainContainer

local tabs = {"TRADE", "CHAT", "TOOLS"}
local activeTab = "TRADE"

local function createTab(name, index)
    local tabBtn = Instance.new("TextButton")
    tabBtn.Size = UDim2.new(1/#tabs, -5, 1, 0)
    tabBtn.Position = UDim2.new((index-1)/#tabs, (index-1)*5, 0, 0)
    tabBtn.BackgroundColor3 = (name == activeTab) and Color3.fromRGB(255, 100, 200) or Color3.fromRGB(60, 30, 55)
    tabBtn.BorderSizePixel = 0
    tabBtn.Text = name
    tabBtn.Font = Enum.Font.GothamBold
    tabBtn.TextSize = 11
    tabBtn.TextColor3 = Color3.new(1,1,1)
    tabBtn.Parent = tabContainer
    
    local tabCorner = Instance.new("UICorner")
    tabCorner.CornerRadius = UDim.new(0, 8)
    tabCorner.Parent = tabBtn
    
    return tabBtn
end

local tabButtons = {}
for i, tab in ipairs(tabs) do
    tabButtons[tab] = createTab(tab, i)
end

-- Content area
local contentFrame = Instance.new("Frame")
contentFrame.Size = UDim2.new(1, -30, 1, -150)
contentFrame.Position = UDim2.new(0, 15, 0, 140)
contentFrame.BackgroundTransparency = 1
contentFrame.Parent = mainContainer

-- Trade content
local tradeContent = Instance.new("ScrollingFrame")
tradeContent.Name = "TradeContent"
tradeContent.Size = UDim2.new(1, 0, 1, 0)
tradeContent.BackgroundTransparency = 1
tradeContent.BorderSizePixel = 0
tradeContent.ScrollBarThickness = 4
tradeContent.ScrollBarImageColor3 = Color3.fromRGB(255, 150, 220)
tradeContent.CanvasSize = UDim2.new(0, 0, 0, 600)
tradeContent.Parent = contentFrame

-- Start Trade Button
local startTradeBtn = Instance.new("TextButton")
startTradeBtn.Size = UDim2.new(1, 0, 0, 40)
startTradeBtn.BackgroundColor3 = Color3.fromRGB(255, 100, 200)
startTradeBtn.BorderSizePixel = 0
startTradeBtn.Text = "START ‚ù§ TRADE ‚Ä¢ 5"
startTradeBtn.Font = Enum.Font.GothamBold
startTradeBtn.TextSize = 14
startTradeBtn.TextColor3 = Color3.new(1,1,1)
startTradeBtn.Parent = tradeContent

local startCorner = Instance.new("UICorner")
startCorner.CornerRadius = UDim.new(0, 10)
startCorner.Parent = startTradeBtn

-- Spectator control
local specControl = Instance.new("Frame")
specControl.Size = UDim2.new(1, 0, 0, 60)
specControl.Position = UDim2.new(0, 0, 0, 50)
specControl.BackgroundColor3 = Color3.fromRGB(40, 20, 35)
specControl.BorderSizePixel = 0
specControl.Parent = tradeContent

local specCorner = Instance.new("UICorner")
specCorner.CornerRadius = UDim.new(0, 10)
specCorner.Parent = specControl

local specLabel = Instance.new("TextLabel")
specLabel.Size = UDim2.new(1, -10, 0, 20)
specLabel.Position = UDim2.new(0, 5, 0, 5)
specLabel.BackgroundTransparency = 1
specLabel.Text = "SPECTATORS"
specLabel.Font = Enum.Font.GothamBold
specLabel.TextSize = 12
specLabel.TextColor3 = Color3.fromRGB(255, 180, 230)
specLabel.TextXAlignment = Enum.TextXAlignment.Left
specLabel.Parent = specControl

local specButtons = {}
for i = 1, 5 do
    local specBtn = Instance.new("TextButton")
    specBtn.Size = UDim2.new(0.16, 0, 0, 25)
    specBtn.Position = UDim2.new(0.05 + (i-1)*0.19, 0, 0, 28)
    specBtn.BackgroundColor3 = (i == desiredMaxSpectators) and Color3.fromRGB(255, 100, 200) or Color3.fromRGB(70, 35, 65)
    specBtn.BorderSizePixel = 0
    specBtn.Text = tostring(i)
    specBtn.Font = Enum.Font.GothamBold
    specBtn.TextSize = 12
    specBtn.TextColor3 = Color3.new(1,1,1)
    specBtn.Parent = specControl
    
    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0, 6)
    btnCorner.Parent = specBtn
    
    specButtons[i] = specBtn
end

-- Action buttons
local actionGrid = Instance.new("Frame")
actionGrid.Size = UDim2.new(1, 0, 0, 130)
actionGrid.Position = UDim2.new(0, 0, 0, 120)
actionGrid.BackgroundTransparency = 1
actionGrid.Parent = tradeContent

local function createActionButton(text, color, position)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0.45, 0, 0, 28)
    btn.Position = position
    btn.BackgroundColor3 = color
    btn.BorderSizePixel = 0
    btn.Text = text
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 12
    btn.TextColor3 = Color3.new(1,1,1)
    btn.Parent = actionGrid
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = btn
    
    return btn
end

local addPetBtn = createActionButton("ADD PETS", Color3.fromRGB(255, 150, 100), UDim2.new(0, 0, 0, 0))
local removePetBtn = createActionButton("REMOVE", Color3.fromRGB(255, 100, 100), UDim2.new(0.55, 0, 0, 0))
local forceAcceptBtn = createActionButton("FORCE ACCEPT", Color3.fromRGB(200, 100, 255), UDim2.new(0, 0, 0, 35))

-- Player selection
local playerSelect = Instance.new("Frame")
playerSelect.Size = UDim2.new(1, 0, 0, 150)
playerSelect.Position = UDim2.new(0, 0, 0, 260)
playerSelect.BackgroundColor3 = Color3.fromRGB(40, 20, 35)
playerSelect.BorderSizePixel = 0
playerSelect.Parent = tradeContent

local playerCorner = Instance.new("UICorner")
playerCorner.CornerRadius = UDim.new(0, 10)
playerCorner.Parent = playerSelect

local playerTitle = Instance.new("TextLabel")
playerTitle.Size = UDim2.new(1, -10, 0, 20)
playerTitle.Position = UDim2.new(0, 5, 0, 5)
playerTitle.BackgroundTransparency = 1
playerTitle.Text = "TRADE PARTNER"
playerTitle.Font = Enum.Font.GothamBold
playerTitle.TextSize = 12
playerTitle.TextColor3 = Color3.fromRGB(255, 180, 230)
playerTitle.TextXAlignment = Enum.TextXAlignment.Left
playerTitle.Parent = playerSelect

local refreshBtn = Instance.new("TextButton")
refreshBtn.Size = UDim2.new(0, 20, 0, 20)
refreshBtn.Position = UDim2.new(1, -25, 0, 5)
refreshBtn.BackgroundTransparency = 1
refreshBtn.Text = "‚Üª"
refreshBtn.Font = Enum.Font.GothamBold
refreshBtn.TextSize = 14
refreshBtn.TextColor3 = Color3.fromRGB(255, 180, 230)
refreshBtn.Parent = playerSelect

local nameInput = Instance.new("TextBox")
nameInput.Size = UDim2.new(1, -10, 0, 25)
nameInput.Position = UDim2.new(0, 5, 0, 30)
nameInput.BackgroundColor3 = Color3.fromRGB(50, 25, 45)
nameInput.BorderSizePixel = 0
nameInput.Text = ""
nameInput.PlaceholderText = "Enter username"
nameInput.Font = Enum.Font.Gotham
nameInput.TextSize = 12
nameInput.TextColor3 = Color3.fromRGB(255, 220, 240)
nameInput.Parent = playerSelect

local inputCorner = Instance.new("UICorner")
inputCorner.CornerRadius = UDim.new(0, 6)
inputCorner.Parent = nameInput

local playerList = Instance.new("ScrollingFrame")
playerList.Size = UDim2.new(1, -10, 1, -70)
playerList.Position = UDim2.new(0, 5, 0, 60)
playerList.BackgroundColor3 = Color3.fromRGB(35, 15, 30)
playerList.BorderSizePixel = 0
playerList.ScrollBarThickness = 4
playerList.CanvasSize = UDim2.new()
playerList.Parent = playerSelect

local listLayout = Instance.new("UIListLayout")
listLayout.Padding = UDim.new(0, 3)
listLayout.Parent = playerList

-- Premade Usernames Section
local premadeSection = Instance.new("Frame")
premadeSection.Size = UDim2.new(1, 0, 0, 130)
premadeSection.Position = UDim2.new(0, 0, 0, 420)
premadeSection.BackgroundColor3 = Color3.fromRGB(40, 20, 35)
premadeSection.BorderSizePixel = 0
premadeSection.Parent = tradeContent

local premadeCorner = Instance.new("UICorner")
premadeCorner.CornerRadius = UDim.new(0, 10)
premadeCorner.Parent = premadeSection

local premadeTitle = Instance.new("TextLabel")
premadeTitle.Size = UDim2.new(1, -10, 0, 20)
premadeTitle.Position = UDim2.new(0, 5, 0, 5)
premadeTitle.BackgroundTransparency = 1
premadeTitle.Text = "PREMADE USERNAMES"
premadeTitle.Font = Enum.Font.GothamBold
premadeTitle.TextSize = 12
premadeTitle.TextColor3 = Color3.fromRGB(255, 180, 230)
premadeTitle.TextXAlignment = Enum.TextXAlignment.Left
premadeTitle.Parent = premadeSection

-- Create premade username buttons (using STATIC_PLAYER_NAMES)
local premadeGrid = Instance.new("Frame")
premadeGrid.Size = UDim2.new(1, -10, 0.7, -5)
premadeGrid.Position = UDim2.new(0, 5, 0, 25)
premadeGrid.BackgroundTransparency = 1
premadeGrid.Parent = premadeSection

-- Function to create premade username buttons
local function createPremadeButtons()
    -- Clear existing buttons
    for _, child in ipairs(premadeGrid:GetChildren()) do
        if child:IsA("TextButton") then
            child:Destroy()
        end
    end
    
    -- Layout for 2 columns
    local columns = 2
    local rows = math.ceil(#STATIC_PLAYER_NAMES / columns)
    
    for i, username in ipairs(STATIC_PLAYER_NAMES) do
        local col = ((i - 1) % columns)
        local row = math.floor((i - 1) / columns)
        
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(1/columns - 0.02, 0, 0.9/rows, 0)
        btn.Position = UDim2.new(col/columns, col*2, row/rows, row*5)
        btn.BackgroundColor3 = Color3.fromRGB(60, 35, 55)
        btn.BorderSizePixel = 0
        btn.Text = username
        btn.Font = Enum.Font.Gotham
        btn.TextSize = 10
        btn.TextColor3 = Color3.fromRGB(255, 220, 240)
        btn.TextTruncate = Enum.TextTruncate.AtEnd
        btn.Parent = premadeGrid
        
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 6)
        corner.Parent = btn
        
        -- Hover effects
        btn.MouseEnter:Connect(function()
            btn.BackgroundColor3 = Color3.fromRGB(80, 50, 75)
        end)
        
        btn.MouseLeave:Connect(function()
            btn.BackgroundColor3 = Color3.fromRGB(60, 35, 55)
        end)
        
        -- Click handler
        btn.MouseButton1Click:Connect(function()
            -- Set the selected premade username
            setCurrentTarget(username, getUserIdFromName(username))
            -- Also update the manual input field
            nameInput.Text = username
            print("[PinkTrade] Selected premade username:", username)
            
            -- Visual feedback
            local originalColor = btn.BackgroundColor3
            btn.BackgroundColor3 = Color3.fromRGB(255, 100, 200)
            task.wait(0.2)
            btn.BackgroundColor3 = originalColor
        end)
    end
end

-- Create the buttons initially
createPremadeButtons()

-- Add a refresh button for premade section
local premadeRefresh = Instance.new("TextButton")
premadeRefresh.Size = UDim2.new(0, 20, 0, 20)
premadeRefresh.Position = UDim2.new(1, -25, 0, 5)
premadeRefresh.BackgroundTransparency = 1
premadeRefresh.Text = "‚Üª"
premadeRefresh.Font = Enum.Font.GothamBold
premadeRefresh.TextSize = 14
premadeRefresh.TextColor3 = Color3.fromRGB(255, 180, 230)
premadeRefresh.Parent = premadeSection

premadeRefresh.MouseButton1Click:Connect(function()
    createPremadeButtons()
    print("[PinkTrade] Refreshed premade usernames")
end)

-- Selected partner display
local selectedPartner = Instance.new("TextLabel")
selectedPartner.Size = UDim2.new(1, -30, 0, 20)
selectedPartner.Position = UDim2.new(0, 15, 1, -125)
selectedPartner.BackgroundTransparency = 1
selectedPartner.Text = "No partner selected"
selectedPartner.Font = Enum.Font.GothamMedium
selectedPartner.TextSize = 11
selectedPartner.TextColor3 = Color3.fromRGB(255, 200, 230)
selectedPartner.TextXAlignment = Enum.TextXAlignment.Left
selectedPartner.Parent = contentFrame

-- Chat content
local chatContent = Instance.new("ScrollingFrame")
chatContent.Name = "ChatContent"
chatContent.Size = UDim2.new(1, 0, 1, 0)
chatContent.BackgroundTransparency = 1
chatContent.BorderSizePixel = 0
chatContent.ScrollBarThickness = 6
chatContent.ScrollBarImageColor3 = Color3.fromRGB(255, 150, 220)
chatContent.Visible = false
chatContent.Parent = contentFrame

local chatTitle = Instance.new("TextLabel")
chatTitle.Size = UDim2.new(1, 0, 0, 25)
chatTitle.Position = UDim2.new(0, 0, 0, 0)
chatTitle.Text = "QUICK CHAT"
chatTitle.Font = Enum.Font.GothamBold
chatTitle.TextSize = 14
chatTitle.TextColor3 = Color3.fromRGB(255, 180, 230)
chatTitle.BackgroundTransparency = 1
chatTitle.Parent = chatContent

-- Create chat buttons with proper scrolling
local chatContainer = Instance.new("Frame")
chatContainer.Size = UDim2.new(1, 0, 0, 500)
chatContainer.Position = UDim2.new(0, 0, 0, 30)
chatContainer.BackgroundTransparency = 1
chatContainer.Parent = chatContent

local chatLayout = Instance.new("UIListLayout")
chatLayout.Padding = UDim.new(0, 5)
chatLayout.SortOrder = Enum.SortOrder.LayoutOrder
chatLayout.Parent = chatContainer

-- Create all chat buttons
for i, msg in ipairs(CHAT_PRESETS) do
    local chatBtn = Instance.new("TextButton")
    chatBtn.Size = UDim2.new(1, -10, 0, 28)
    chatBtn.Position = UDim2.new(0, 5, 0, 0)
    chatBtn.BackgroundColor3 = Color3.fromRGB(60, 30, 55)
    chatBtn.BorderSizePixel = 0
    chatBtn.Text = "  " .. msg
    chatBtn.Font = Enum.Font.Gotham
    chatBtn.TextSize = 11
    chatBtn.TextColor3 = Color3.fromRGB(255, 220, 240)
    chatBtn.TextXAlignment = Enum.TextXAlignment.Left
    chatBtn.LayoutOrder = i
    chatBtn.Parent = chatContainer
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = chatBtn
    
    chatBtn.MouseButton1Click:Connect(function()
        local state = getLocalState()
        if not state then
            warn("[PinkTrade] no open trade ‚Äì quick chat ignored")
            return
        end

        local senderRef = state.recipient
        if not senderRef or type(senderRef) ~= "table" then
            senderRef = {
                Name = currentTargetName,
                UserId = currentTargetId or 0,
                DisplayName = currentTargetDisplayName,
            }
        end

        TradeApp:_render_message_in_trade_chat(
            senderRef,
            msg,
            false,
            false
        )

        print("[PinkTrade] partner quick-chat ->", currentTargetDisplayName, ":", msg)
    end)
end

-- Update chat content canvas size
chatLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    chatContainer.Size = UDim2.new(1, 0, 0, chatLayout.AbsoluteContentSize.Y)
    chatContent.CanvasSize = UDim2.new(0, 0, 0, chatLayout.AbsoluteContentSize.Y + 40)
end)

-- Tools content
local toolsContent = Instance.new("ScrollingFrame")
toolsContent.Name = "ToolsContent"
toolsContent.Size = UDim2.new(1, 0, 1, 0)
toolsContent.BackgroundTransparency = 1
toolsContent.BorderSizePixel = 0
toolsContent.ScrollBarThickness = 4
toolsContent.ScrollBarImageColor3 = Color3.fromRGB(255, 150, 220)
toolsContent.Visible = false
toolsContent.CanvasSize = UDim2.new(0, 0, 0, 200)
toolsContent.Parent = contentFrame

local function createToolCard(title, desc, color, yPos, callback)
    local card = Instance.new("Frame")
    card.Size = UDim2.new(1, 0, 0, 70)
    card.Position = UDim2.new(0, 0, 0, yPos)
    card.BackgroundColor3 = Color3.fromRGB(50, 25, 45)
    card.BorderSizePixel = 0
    card.Parent = toolsContent
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 10)
    corner.Parent = card
    
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(1, -10, 0, 20)
    titleLabel.Position = UDim2.new(0, 5, 0, 8)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = title
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextSize = 14
    titleLabel.TextColor3 = color
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.Parent = card
    
    local descLabel = Instance.new("TextLabel")
    descLabel.Size = UDim2.new(1, -10, 0, 15)
    descLabel.Position = UDim2.new(0, 5, 0, 28)
    descLabel.BackgroundTransparency = 1
    descLabel.Text = desc
    descLabel.Font = Enum.Font.Gotham
    descLabel.TextSize = 10
    descLabel.TextColor3 = Color3.fromRGB(255, 200, 220)
    descLabel.TextXAlignment = Enum.TextXAlignment.Left
    descLabel.Parent = card
    
    local toolBtn = Instance.new("TextButton")
    toolBtn.Size = UDim2.new(0.6, 0, 0, 25)
    toolBtn.Position = UDim2.new(0.2, 0, 0, 45)
    toolBtn.BackgroundColor3 = color
    toolBtn.BorderSizePixel = 0
    toolBtn.Text = "LAUNCH"
    toolBtn.Font = Enum.Font.GothamBold
    toolBtn.TextSize = 11
    toolBtn.TextColor3 = Color3.new(1,1,1)
    toolBtn.Parent = card
    
    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = UDim.new(0, 8)
    btnCorner.Parent = toolBtn
    
    toolBtn.MouseButton1Click:Connect(callback)
end

-- Placeholder functions for tool cards
local function runPetSpawner()
    print("[PinkTrade] Pet Spawner launched")
end

local function runBotSpawner()
    print("[PinkTrade] Bot Spawner launched")
end

-- Create tool cards
createToolCard("PET SPAWNER PRO", "Enhanced spawner with bypass system", Color3.fromRGB(255, 150, 200), 10, runPetSpawner)
createToolCard("BOT SPAWNER", "Create trader bots around you", Color3.fromRGB(200, 100, 255), 90, runBotSpawner)

-- Tab switching
local function switchTab(tabName)
    tradeContent.Visible = (tabName == "TRADE")
    chatContent.Visible = (tabName == "CHAT")
    toolsContent.Visible = (tabName == "TOOLS")
    activeTab = tabName
    
    for t, btn in pairs(tabButtons) do
        btn.BackgroundColor3 = (t == tabName) and Color3.fromRGB(255, 100, 200) or Color3.fromRGB(60, 30, 55)
    end
end

for tab, btn in pairs(tabButtons) do
    btn.MouseButton1Click:Connect(function()
        switchTab(tab)
    end)
end

-- UI Controls
UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.RightShift then
        mainContainer.Visible = not mainContainer.Visible
    end
end)

closeBtn.MouseButton1Click:Connect(function()
    mainContainer.Visible = false
end)

activateBtn.MouseButton1Click:Connect(function()
    introFrame.Visible = false
    mainContainer.Visible = true
    -- Animate entrance
    mainContainer.Position = UDim2.new(0, -250, 0, 100)
    local tween = TweenService:Create(mainContainer, TweenInfo.new(0.3, Enum.EasingStyle.Quad), {
        Position = UDim2.new(0, 15, 0, 100)
    })
    tween:Play()
end)

-- Set spectator count
for i, btn in ipairs(specButtons) do
    btn.MouseButton1Click:Connect(function()
        desiredMaxSpectators = i
        for j, b in ipairs(specButtons) do
            b.BackgroundColor3 = (j == i) and Color3.fromRGB(255, 100, 200) or Color3.fromRGB(70, 35, 65)
        end
        startTradeBtn.Text = string.format("START ‚ù§ TRADE ‚Ä¢ %d", desiredMaxSpectators)
    end)
end

local function createPlayerButton(displayName, userId, isStatic, layoutOrder)
    local b = Instance.new("TextButton")
    b.Name = displayName
    b.Size = UDim2.new(1, 0, 0, 22)
    b.BackgroundColor3 = isStatic and Color3.fromRGB(80, 40, 70) or Color3.fromRGB(50, 25, 45)
    b.BorderSizePixel = 0
    b.Font = Enum.Font.Gotham
    b.TextSize = 11
    b.TextColor3 = Color3.new(1,1,1)
    b.TextXAlignment = Enum.TextXAlignment.Left
    b.Text = "  " .. displayName
    b.LayoutOrder = layoutOrder or 0
    b.Parent = playerList
    
    local c = Instance.new("UICorner")
    c.CornerRadius = UDim.new(0, 6)
    c.Parent = b
    
    b.MouseButton1Click:Connect(function()
        setCurrentTarget(displayName, userId)
        print("[PinkTrade] selected partner:", displayName, "(ID:", userId, ")")
    end)
end

local function rebuildPlayerList()
    for _, child in ipairs(playerList:GetChildren()) do
        if child:IsA("TextButton") then
            child:Destroy()
        end
    end

    local usedReal = {}
    local order = 0

    -- Static names first
    for _, name in ipairs(STATIC_PLAYER_NAMES) do
        local plr = Players:FindFirstChild(name)
        if plr and plr ~= LocalPlayer then
            usedReal[plr] = true
            createPlayerButton(plr.Name, plr.UserId, false, order)
        else
            local uid = getUserIdFromName(name)
            createPlayerButton(name, uid, true, order)
        end
        order += 1
    end

    -- All other real players
    local realOrder = 100
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and not usedReal[plr] and not table.find(STATIC_PLAYER_NAMES, plr.Name) then
            createPlayerButton(plr.Name, plr.UserId, false, realOrder)
            realOrder += 1
        end
    end

    playerList.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y)
end

refreshBtn.MouseButton1Click:Connect(rebuildPlayerList)
Players.PlayerAdded:Connect(rebuildPlayerList)
Players.PlayerRemoving:Connect(rebuildPlayerList)
rebuildPlayerList()

-- Manual username entry
nameInput.FocusLost:Connect(function(enterPressed)
    if not enterPressed then return end
    local text = nameInput.Text or ""
    text = text:gsub("^%s+", ""):gsub("%s+$", "")
    if text == "" then return end

    local typedDisplay = text
    local lookupName = text
    local chosenId = 0

    for _, plr in ipairs(Players:GetPlayers()) do
        if plr.Name:lower() == text:lower() then
            lookupName = plr.Name
            chosenId = plr.UserId
            break
        end
    end

    if chosenId == 0 then
        chosenId = getUserIdFromName(lookupName)
    end

    setCurrentTarget(typedDisplay, chosenId)
    print("[PinkTrade] manual partner set to:", typedDisplay, "(ID:", chosenId, ")")
end)

-- Random spectator loop
local function startSpectatorLoop()
    if spectatorLoopRunning then return end
    spectatorLoopRunning = true

    task.spawn(function()
        while spectatorLoopRunning and fakeActive do
            task.wait(math.random(7, 13))
            if not fakeActive then break end
            local newCount = math.random(1, math.max(1, desiredMaxSpectators))
            local s = getLocalState()
            if s and s.trade_id == fakeTradeId then
                allowOverwrite = true
                s.subscriber_count = newCount
                TradeApp:_overwrite_local_trade_state(s)
                allowOverwrite = false
                TradeApp:refresh_all()
            end
        end
        spectatorLoopRunning = false
    end)
end

local function stopSpectatorLoop()
    spectatorLoopRunning = false
end

-- Restore hooks
local function restoreHooks()
    TradeApp._on_accept_pressed = originalAccept
    TradeApp._on_confirm_pressed = originalConfirm
    TradeApp._overwrite_local_trade_state = originalOverwrite
    TradeApp._remove_item_from_my_offer = originalRemove

    blockRealTrades = false
    stopSpectatorLoop()
    stopNameFix()
end

-- Remove last from offer helper
local function removeLastFromOffer(sideKey)
    local s = getLocalState()
    if not s or s.trade_id ~= fakeTradeId then return nil, nil end
    local offer = s[sideKey]
    if not offer or not offer.items or #offer.items == 0 then return nil, nil end

    local removed = table.remove(offer.items)

    allowOverwrite = true
    TradeApp:_overwrite_local_trade_state(s)
    allowOverwrite = false
    TradeApp:_lock_trade_for_appropriate_time()
    tradeUnlockAt = os.clock() + LOCK_DURATION
    TradeApp:refresh_all()

    return removed, sideKey
end

-- Force partner accept
local function forcePartnerAccept()
    if os.clock() < tradeUnlockAt then
        warn("[PinkTrade] trade is currently locked ‚Äì wait for the timer to finish")
        return
    end

    local s = getLocalState()
    if not s or s.trade_id ~= fakeTradeId then
        warn("[PinkTrade] no active visual trade ‚Äì can't force accept")
        return
    end

    s.recipient_offer.negotiated = true
    s.recipient_offer.confirmed = false
    s.recipient_offer.player_name = currentTargetDisplayName

    allowOverwrite = true
    TradeApp:_overwrite_local_trade_state(s)
    allowOverwrite = false
    TradeApp:refresh_all()

    TradeApp:_render_message_in_trade_chat(
        nil,
        string.format("%s accepted the trade", currentTargetDisplayName),
        false,
        true
    )

    print("[PinkTrade] forced partner accept")
end

-- Add pet to partner
local function addPetToPartner()
    local s = getLocalState()
    if not s or s.trade_id ~= fakeTradeId then
        warn("[PinkTrade] no active visual trade ‚Äì start one first")
        return
    end

    local offer = s.recipient_offer
    if not offer then
        warn("[PinkTrade] recipient_offer missing in state")
        return
    end

    local petKind = PET_KINDS[math.random(1, #PET_KINDS)]
    local propsDef = RARITY_PROPS[math.random(1, #RARITY_PROPS)]
    local props = {
        mega_neon = propsDef.mega_neon;
        neon = propsDef.neon;
        flyable = propsDef.flyable;
        rideable = propsDef.rideable;
    }

    offer.items = offer.items or {}
    local newItem = {
        unique = "pet_" .. petKind .. "_" .. math.random(10000, 99999),
        category = "pets",
        kind = petKind,
        properties = props,
    }
    table.insert(offer.items, newItem)

    allowOverwrite = true
    TradeApp:_overwrite_local_trade_state(s)
    allowOverwrite = false
    TradeApp:_lock_trade_for_appropriate_time()
    tradeUnlockAt = os.clock() + LOCK_DURATION
    TradeApp:refresh_all()

    local tag = tagForProps(props)
    local niceName = formatPetName(petKind)
    TradeApp:_render_message_in_trade_chat(nil,
        string.format("%s added %s %s", currentTargetDisplayName, tag, niceName),
        false, true
    )

    print(string.format("[PinkTrade] added %s %s to partner offer", tag, petKind))
end

-- Remove pet from partner
local function removePetFromPartner()
    local removed = select(1, removeLastFromOffer("recipient_offer"))
    if not removed then
        print("[PinkTrade] no pets to remove from partner")
        return
    end

    local tag = removed.properties and tagForProps(removed.properties) or "FR"
    local niceName = removed.kind and formatPetName(removed.kind) or "Pet"
    TradeApp:_render_message_in_trade_chat(nil,
        string.format("%s removed %s %s", currentTargetDisplayName, tag, niceName),
        false, true
    )
    print(string.format("[PinkTrade] removed %s %s from partner offer", tag, removed.kind or "?"))
end

-- Button connections
addPetBtn.MouseButton1Click:Connect(addPetToPartner)
removePetBtn.MouseButton1Click:Connect(removePetFromPartner)
forceAcceptBtn.MouseButton1Click:Connect(forcePartnerAccept)

-- Start visual trade
local function startVisualTrade()
    if fakeActive then
        local s = getLocalState()
        if not s or s.trade_id ~= fakeTradeId then
            warn("[PinkTrade] stale visual trade state detected ‚Äì resetting.")
            fakeActive = false
            fakeTradeId = nil
            stopSpectatorLoop()
            restoreHooks()
        else
            warn("[PinkTrade] visual trade already running")
            return
        end
    end

    tradeUnlockAt = 0

    local targetPlayer = nil
    if currentTargetId and currentTargetId ~= 0 then
        targetPlayer = Players:GetPlayerByUserId(currentTargetId)
    end
    if not targetPlayer and currentTargetName then
        targetPlayer = Players:FindFirstChild(currentTargetName)
    end
    if targetPlayer == LocalPlayer then
        targetPlayer = nil
    end

    if targetPlayer then
        currentTargetName = targetPlayer.Name
        currentTargetId = targetPlayer.UserId
        currentTargetDisplayName = targetPlayer.Name
        selectedPartner.Text = "Partner: " .. currentTargetDisplayName
    end

    local target
    if targetPlayer then
        target = targetPlayer
    else
        target = {
            Name = currentTargetName,
            UserId = currentTargetId or 0,
            DisplayName = currentTargetDisplayName,
        }
    end

    local dlg = {
        text = string.format("%s sent you a trade request", currentTargetDisplayName),
        left = "Decline",
        right = "Accept",
    }

    allowMockDialog = true
    local response = UIManager.apps.DialogApp:dialog(dlg)
    allowMockDialog = false

    print("[PinkTrade] trade request response:", response)

    if response ~= "Accept" then
        print("[PinkTrade] trade declined")
        return
    end

    blockRealTrades = true
    fakeTradeId = "visual_trade_" .. math.random(10000, 99999)

    local state = {
        trade_id = fakeTradeId,
        sender = LocalPlayer,
        recipient = target,
        sender_offer = {
            items = {},
            negotiated = false,
            confirmed = false,
            player_name = LocalPlayer.Name,
        },
        recipient_offer = {
            items = {},
            negotiated = false,
            confirmed = false,
            player_name = currentTargetDisplayName,
        },
        current_stage = "negotiation",
        offer_version = 1,
        sender_has_trade_license = true,
        recipient_has_trade_license = true,
        busy_indicators = {},
        subscriber_count = 1,
    }

    print(string.format("[PinkTrade] setting up visual trade with %d max spectators...", desiredMaxSpectators))
    print(string.format("[PinkTrade] trading with: %s (ID: %d)", currentTargetDisplayName, currentTargetId))

    -- Enable fake trade hooks
    fakeActive = true
    startNameFix()

    TradeApp._overwrite_local_trade_state = function(self, trade, ...)
        if trade == nil and fakeActive and not allowOverwrite then
            print("[PinkTrade] trade state cleared externally ‚Äì resetting hooks")
            fakeActive = false
            fakeTradeId = nil
            stopSpectatorLoop()
            restoreHooks()
            return originalOverwrite(self, trade, ...)
        end

        if not fakeActive or allowOverwrite then
            return originalOverwrite(self, trade, ...)
        end

        if trade == nil then
            fakeActive = false
            fakeTradeId = nil
            stopSpectatorLoop()
            restoreHooks()
            return originalOverwrite(self, trade, ...)
        end

        if trade and trade.trade_id and trade.trade_id ~= fakeTradeId then
            print("[PinkTrade] blocked real trade overwrite")
            return
        end

        return originalOverwrite(self, trade, ...)
    end

    TradeApp._remove_item_from_my_offer = function(self, item)
        local s = getLocalState()
        if not fakeActive or not s or s.trade_id ~= fakeTradeId or not item or not item.unique then
            return originalRemove(self, item)
        end

        local removedItem, removedSide

        local function trySide(key)
            local offer = s[key]
            if not offer or not offer.items then return false end
            for i, v in ipairs(offer.items) do
                if v.unique == item.unique then
                    removedItem = v
                    removedSide = key
                    table.remove(offer.items, i)
                    return true
                end
            end
            return false
        end

        if not trySide("recipient_offer") and not trySide("sender_offer") then
            return originalRemove(self, item)
        end

        allowOverwrite = true
        TradeApp:_overwrite_local_trade_state(s)
        allowOverwrite = false
        TradeApp:_lock_trade_for_appropriate_time()
        tradeUnlockAt = os.clock() + LOCK_DURATION
        TradeApp:refresh_all()

        if removedItem then
            local tag = removedItem.properties and tagForProps(removedItem.properties) or "FR"
            local nice = removedItem.kind and formatPetName(removedItem.kind) or "Pet"
            local who = (removedSide == "sender_offer") and LocalPlayer.Name or currentTargetDisplayName

            self:_render_message_in_trade_chat(
                nil,
                string.format("%s removed %s %s", who, tag, nice),
                false,
                true
            )

            print(string.format(
                "[PinkTrade] removed %s %s from %s offer",
                tag,
                removedItem.kind or "?",
                who
            ))
        end
    end

    TradeApp._on_accept_pressed = function(self, ...)
        local s = self:_get_local_trade_state()
        if not fakeActive or not s or s.trade_id ~= fakeTradeId then
            return originalAccept(self, ...)
        end

        if os.clock() < tradeUnlockAt then
            local remaining = math.max(0, tradeUnlockAt - os.clock())
            warn(("[PinkTrade] your side is locked for %.1fs more"):format(remaining))
            return
        end

        print("[PinkTrade] you clicked Accept")

        s.sender_offer.negotiated = true
        s.sender_offer.confirmed = false
        s.sender_offer.player_name = LocalPlayer.Name

        if s.recipient_offer and s.recipient_offer.negotiated then
            s.current_stage = "confirmation"
            s.offer_version = (s.offer_version or 1) + 1

            allowOverwrite = true
            TradeApp:_overwrite_local_trade_state(s)
            allowOverwrite = false
            TradeApp:refresh_all()

            print("[PinkTrade] both accepted ‚Äì now in confirmation stage")
            return
        end

        allowOverwrite = true
        TradeApp:_overwrite_local_trade_state(s)
        allowOverwrite = false
        TradeApp:refresh_all()

        print("[PinkTrade] auto-accepting partner in 2 seconds...")
        task.delay(2, function()
            local s2 = getLocalState()
            if not fakeActive or not s2 or s2.trade_id ~= fakeTradeId then return end

            s2.recipient_offer.negotiated = true
            s2.recipient_offer.confirmed = false
            s2.recipient_offer.player_name = currentTargetDisplayName
            s2.current_stage = "confirmation"
            s2.offer_version = (s2.offer_version or 1) + 1

            allowOverwrite = true
            TradeApp:_overwrite_local_trade_state(s2)
            allowOverwrite = false
            TradeApp:refresh_all()

            print("[PinkTrade] both accepted ‚Äì now in confirmation stage")
        end)
    end

    TradeApp._on_confirm_pressed = function(self, ...)
        local s = self:_get_local_trade_state()
        if not fakeActive or not s or s.trade_id ~= fakeTradeId then
            return originalConfirm(self, ...)
        end

        print("[PinkTrade] you clicked Confirm")

        s.sender_offer.negotiated = true
        s.sender_offer.confirmed = true
        s.sender_offer.player_name = LocalPlayer.Name

        allowOverwrite = true
        TradeApp:_overwrite_local_trade_state(s)
        allowOverwrite = false
        TradeApp:refresh_all()

        print("[PinkTrade] auto-confirming partner in 2 seconds...")
        task.delay(2, function()
            local s2 = getLocalState()
            if not s2 or not fakeActive or s2.trade_id ~= fakeTradeId then return end

            s2.recipient_offer.negotiated = true
            s2.recipient_offer.confirmed = true
            s2.recipient_offer.player_name = currentTargetDisplayName

            allowOverwrite = true
            TradeApp:_overwrite_local_trade_state(s2)
            allowOverwrite = false
            TradeApp:refresh_all()

            print("[PinkTrade] both confirmed ‚Äì finishing trade...")

            task.delay(2, function()
                pcall(function()
                    if self.frame and self.frame.Parent then
                        self.frame:Destroy()
                    end
                    self:hide()
                    allowOverwrite = true
                    self:_overwrite_local_trade_state(nil)
                    allowOverwrite = false
                end)

                fakeActive = false
                fakeTradeId = nil
                stopSpectatorLoop()
                restoreHooks()

                if UIManager.apps.HintApp then
                    UIManager.apps.HintApp:hint({
                        text = "The trade was successful!";
                        length = 3;
                        overridable = true;
                    })
                end

                print("[PinkTrade] Trade finished.")
                statusText.Text = "Ready"
                statusText.TextColor3 = Color3.fromRGB(255, 180, 230)
            end)
        end)
    end

    allowOverwrite = true
    TradeApp:_overwrite_local_trade_state(state)
    allowOverwrite = false

    UIManager.set_app_visibility("TradeApp", true)
    task.wait(0.4)
    TradeApp:refresh_all()

    startSpectatorLoop()
    print("[PinkTrade] trade window opened")
    statusText.Text = "In Trade: " .. currentTargetDisplayName
    statusText.TextColor3 = Color3.fromRGB(255, 220, 150)
end

startTradeBtn.MouseButton1Click:Connect(startVisualTrade)

print("[PinkTrade] Visual Trade Tool loaded.")
print("  ‚Äì Click 'ACTIVATE ‚ù§' to start")
print("  ‚Äì RightShift to show/hide panel")
print("  ‚Äì Choose partner, click 'START ‚ù§ TRADE'")
